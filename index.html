<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINKIFG - Intelligence Sales</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        background: '#F9FAFB',
                        surface: '#FFFFFF',
                        primary: '#111827',
                        secondary: '#6B7280',
                        accent: '#3B82F6',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #F3F4F6;
            height: 100vh;
            overflow: hidden;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>

<body class="flex h-screen text-slate-800">

    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-slate-200 flex flex-col justify-between">
        <div class="p-6">
            <h1 class="text-xl font-bold tracking-tight text-slate-900 mb-8 flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-blue-600"></span> LINKIFG
            </h1>

            <nav class="space-y-1">
                <a href="#"
                    class="flex items-center gap-3 px-3 py-2 text-sm font-medium text-blue-600 bg-blue-50 rounded-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                        </path>
                    </svg>
                    Inbox
                    <span id="unread-count"
                        class="ml-auto bg-blue-600 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden">0</span>
                </a>
                <a href="#"
                    class="flex items-center gap-3 px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-50 rounded-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                        </path>
                    </svg>
                    Leads
                </a>
                <a href="#"
                    class="flex items-center gap-3 px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-50 rounded-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                        </path>
                    </svg>
                    Performance
                </a>
            </nav>
        </div>

        <div class="p-4 border-t border-slate-200">
            <button onclick="triggerScrape()"
                class="w-full flex items-center justify-center gap-2 bg-slate-900 hover:bg-slate-800 text-white px-4 py-2.5 rounded-lg text-sm font-medium transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                    </path>
                </svg>
                Sync LinkedIn
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-w-0 bg-white">
        <!-- Top Stats Bar -->
        <header class="h-16 border-b border-slate-200 flex items-center justify-between px-6 bg-white">
            <div class="flex items-center gap-8">
                <div>
                    <span class="text-xs text-slate-500 uppercase font-semibold tracking-wider">Prospects</span>
                    <p class="text-lg font-bold text-slate-900" id="stat-prospects">--</p>
                </div>
                <div>
                    <span class="text-xs text-slate-500 uppercase font-semibold tracking-wider">À Répondre (<
                            24h)</span>
                            <p class="text-lg font-bold text-red-600" id="stat-urgent">--</p>
                </div>
                <div>
                    <span class="text-xs text-slate-500 uppercase font-semibold tracking-wider">Opportunités</span>
                    <p class="text-lg font-bold text-emerald-600" id="stat-opportunities">--</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <span
                    class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                    System Operational
                </span>
            </div>
        </header>

        <!-- Two Column View -->
        <div class="flex-1 flex overflow-hidden">

            <!-- Conversation List (Left) -->
            <div class="w-96 border-r border-slate-200 flex flex-col bg-slate-50">
                <div class="p-4 border-b border-slate-200 sticky top-0 bg-slate-50 z-10">
                    <div class="relative">
                        <input type="text" placeholder="Rechercher un prospect..."
                            class="w-full pl-9 pr-4 py-2 bg-white border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <svg class="w-4 h-4 text-slate-400 absolute left-3 top-2.5" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                </div>

                <div id="conversation-list" class="flex-1 overflow-y-auto">
                    <!-- Loading State -->
                    <div class="p-8 text-center text-slate-500">
                        <svg class="animate-spin h-8 w-8 mx-auto mb-2 text-blue-500" xmlns="http://www.w3.org/2000/svg"
                            fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                        Chargement des conversations...
                    </div>
                </div>
            </div>

            <!-- Message Detail (Right) -->
            <div id="message-view" class="flex-1 flex flex-col bg-white">
                <div class="h-full flex items-center justify-center text-slate-400">
                    <div class="text-center">
                        <svg class="w-16 h-16 mx-auto mb-4 text-slate-200" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                            </path>
                        </svg>
                        <p>Sélectionnez une conversation pour voir les détails</p>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        const SUPABASE_URL = 'https://igyxcobujacampiqndpf.supabase.co';
        // Public Anon Key is safe for client-side
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlneXhjb2J1amFjYW1waXFuZHBmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NDYxMTUsImV4cCI6MjA4NTUyMjExNX0.8jgz6G0Irj6sRclcBKzYE5VzzXNrxzHgrAz45tHfHpc';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let activeConversationId = null;

        // --- Logic: Sorting Essentials ---
        // 1. Unanswered by me (Needs Reply) -> Top Priority
        // 2. Unanswered by them for > 3 days (Needs Followup) -> Medium Priority
        // 3. Newest otherwise
        function getPriorityScore(conv, lastMsg) {
            const now = new Date();
            const msgDate = new Date(lastMsg ? lastMsg.timestamp : conv.created_at);
            const daysDiff = (now - msgDate) / (1000 * 60 * 60 * 24);

            if (lastMsg && lastMsg.sender !== 'me') {
                // They wrote last. High priority. 
                // Older it is, HIGHER the priority (don't leave them hanging)
                return 1000 + daysDiff;
            }
            if (lastMsg && lastMsg.sender === 'me' && daysDiff > 3) {
                // I wrote last, > 3 days ago. Ghosted? Need followup.
                return 500 + daysDiff;
            }
            // Normal chronology
            return msgDate.getTime() / 10000000000;
        }

        async function loadConversations() {
            // Fetch Conversations + Prospects + Last Message
            const { data: conversations, error } = await supabase
                .from('conversations')
                .select(`
                    id,
                    last_message_at,
                    last_message_by,
                    unread_count,
                    status,
                    engagement_level,
                    prospects (name, company, job_title, linkedin_url),
                    messages (content, sender, timestamp)
                `)
                .order('last_message_at', { ascending: false });

            if (error) {
                console.error("Error fetching data:", error);
                return;
            }

            // Process & Sort
            const sortedConvs = conversations.map(c => {
                // Get absolute last message
                const lastMsg = c.messages && c.messages.length > 0
                    ? c.messages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0]
                    : null;

                return {
                    ...c,
                    lastMsg,
                    score: getPriorityScore(c, lastMsg)
                };
            }).sort((a, b) => b.score - a.score); // Descending score

            renderList(sortedConvs);
            updateStats(sortedConvs);
        }

        function renderList(conversations) {
            const container = document.getElementById('conversation-list');
            container.innerHTML = '';

            conversations.forEach(conv => {
                const isSelected = conv.id === activeConversationId;
                const lastMsgContent = conv.lastMsg ? conv.lastMsg.content : 'Nouvelle connexion';
                const timeAgo = conv.lastMsg ? timeSince(new Date(conv.lastMsg.timestamp)) : '';

                // Badge Logic
                let badge = '';
                if (conv.lastMsg?.sender !== 'me') {
                    badge = `<span class="bg-red-100 text-red-700 text-xs px-2 py-0.5 rounded-full font-bold">À répondre</span>`;
                } else if (new Date() - new Date(conv.last_message_at) > 3 * 24 * 60 * 60 * 1000) {
                    badge = `<span class="bg-amber-100 text-amber-700 text-xs px-2 py-0.5 rounded-full font-bold">Relance requise</span>`;
                }

                const div = document.createElement('div');
                div.className = `p-4 border-b border-slate-100 cursor-pointer transition hover:bg-slate-50 ${isSelected ? 'bg-blue-50 border-l-4 border-l-blue-600' : 'border-l-4 border-l-transparent'}`;
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <h3 class="font-semibold text-slate-900 truncate pr-2">${conv.prospects?.name || 'Inconnu'}</h3>
                        <span class="text-xs text-slate-400 whitespace-nowrap">${timeAgo}</span>
                    </div>
                    <div class="text-xs text-slate-500 mb-2 truncate">${conv.prospects?.job_title || ''} @ ${conv.prospects?.company || ''}</div>
                    <p class="text-sm text-slate-600 line-clamp-2 mb-2">${lastMsgContent}</p>
                    <div class="flex items-center gap-2">
                        ${badge}
                        <span class="text-xs px-2 py-0.5 rounded-full bg-slate-100 text-slate-600 border border-slate-200 capitalize">${conv.engagement_level || 'cold'}</span>
                    </div>
                `;
                div.onclick = () => selectConversation(conv);
                container.appendChild(div);
            });
        }

        async function selectConversation(conv) {
            activeConversationId = conv.id;
            loadConversations(); // Re-render list to show active state

            const view = document.getElementById('message-view');

            // Generate Chat View
            view.innerHTML = `
                <!-- Chat Header -->
                <div class="h-16 border-b border-slate-200 flex items-center justify-between px-6 bg-white shrink-0">
                    <div class="flex items-center gap-4">
                        <div class="h-10 w-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-lg">
                            ${conv.prospects?.name?.charAt(0) || '?'}
                        </div>
                        <div>
                            <h2 class="font-bold text-slate-900">${conv.prospects?.name}</h2>
                            <a href="${conv.prospects?.linkedin_url}" target="_blank" class="text-xs text-blue-600 hover:underline flex items-center gap-1">
                                Voir sur LinkedIn
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                            </a>
                        </div>
                    </div>
                    <div class="flex gap-2">
                         <button class="px-3 py-1.5 text-sm font-medium text-slate-600 border border-slate-300 rounded hover:bg-slate-50">Qualifier</button>
                         <button class="px-3 py-1.5 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700">Archiver</button>
                    </div>
                </div>

                <!-- Messages Area -->
                <div class="flex-1 overflow-y-auto p-6 bg-slate-50 space-y-6" id="messages-container">
                    ${renderMessages(conv.messages)}
                </div>

                <!-- Input Area (Placeholder) -->
                <div class="p-4 bg-white border-t border-slate-200">
                    <div class="relative">
                        <textarea class="w-full border border-slate-300 rounded-lg p-3 pr-12 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" rows="3" placeholder="Écrivez votre réponse ou générez-là avec l'IA..."></textarea>
                        <button class="absolute right-3 bottom-3 p-2 text-blue-600 hover:bg-blue-50 rounded-full transition" title="Générer avec IA">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        </button>
                    </div>
                </div>
            `;

            // Scroll to bottom
            const container = document.getElementById('messages-container');
            container.scrollTop = container.scrollHeight;
        }

        function renderMessages(messages) {
            if (!messages || messages.length === 0) return '<div class="text-center text-slate-400 my-10">Aucun message</div>';

            return messages
                .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
                .map(msg => {
                    const isMe = msg.sender === 'me';
                    return `
                        <div class="flex w-full ${isMe ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-[70%] ${isMe ? 'bg-blue-600 text-white rounded-l-2xl rounded-tr-2xl' : 'bg-white border border-slate-200 text-slate-800 rounded-r-2xl rounded-tl-2xl'} px-5 py-3 shadow-sm">
                                <p class="text-sm leading-relaxed">${msg.content}</p>
                                <p class="text-[10px] mt-1 opacity-70 ${isMe ? 'text-blue-100 text-right' : 'text-slate-400'}">${new Date(msg.timestamp).toLocaleString()}</p>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function updateStats(convs) {
            document.getElementById('stat-prospects').textContent = convs.length;

            // "Urgent": msg from 'them' (unread handling simplified here)
            const urgentCount = convs.filter(c => c.lastMsg && c.lastMsg.sender !== 'me').length;
            document.getElementById('stat-urgent').textContent = urgentCount;

            const oppCount = convs.filter(c => c.engagement_level === 'hot' || c.engagement_level === 'warm').length;
            document.getElementById('stat-opportunities').textContent = oppCount;
        }

        function timeSince(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " an(s)";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " mois";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " j";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " h";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " min";
            return "à l'instant";
        }

        async function triggerScrape() {
            const btn = document.querySelector('button[onclick="triggerScrape()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Synchronisation...`;
            btn.disabled = true;

            try {
                await fetch(`${SUPABASE_URL}/functions/v1/scrape-linkedin`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                alert('Synchronisation lancée ! Les messages arriveront dans quelques instants.');
            } catch (e) {
                alert('Erreur lors du lancement du scraping.');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                setTimeout(loadConversations, 5000); // Reload after delay
            }
        }

        // Init
        loadConversations();

        // Realtime
        supabase.channel('public:conversations')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'conversations' }, loadConversations)
            .subscribe();
    </script>
</body>

</html>