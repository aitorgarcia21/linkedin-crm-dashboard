<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINKIFG - Pipeline</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Inter',sans-serif; background:#F3F4F6; height:100vh; overflow:hidden; display:flex; color:#1F2937; }

        /* Left: Pipeline */
        .pipeline-panel {
            flex:1; display:flex; flex-direction:column; overflow:hidden;
        }
        .pipeline-header {
            padding:16px 24px; background:#fff; border-bottom:1px solid #E5E7EB;
            display:flex; align-items:center; gap:16px; flex-wrap:wrap;
        }
        .pipeline-header h1 { font-size:18px; font-weight:700; }
        .pipeline-header .stats { display:flex; gap:12px; margin-left:auto; flex-wrap:wrap; }
        .stat-pill { padding:4px 12px; border-radius:20px; font-size:12px; font-weight:600; }
        .pipeline-actions { display:flex; gap:8px; }
        .btn { padding:8px 16px; border-radius:8px; font-size:13px; font-weight:600; border:none; cursor:pointer; }
        .btn-primary { background:linear-gradient(135deg,#3B82F6,#8B5CF6); color:#fff; }
        .btn-primary:hover { opacity:0.9; }
        .btn-outline { background:#fff; border:1px solid #E5E7EB; color:#374151; }
        .btn-outline:hover { background:#F9FAFB; }
        .btn:disabled { opacity:0.5; cursor:not-allowed; }

        /* Kanban board */
        .kanban { display:flex; flex:1; overflow-x:auto; padding:16px; gap:12px; }
        .kanban-col { min-width:240px; max-width:280px; flex:1; display:flex; flex-direction:column; background:#fff; border-radius:12px; border:1px solid #E5E7EB; overflow:hidden; }
        .kanban-col-header { padding:12px 16px; font-size:13px; font-weight:700; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #E5E7EB; }
        .kanban-col-header .count { background:#E5E7EB; color:#374151; padding:2px 8px; border-radius:10px; font-size:11px; }
        .kanban-col.cold .kanban-col-header { background:#F0F9FF; color:#0369A1; }
        .kanban-col.warm .kanban-col-header { background:#FFFBEB; color:#92400E; }
        .kanban-col.hot .kanban-col-header { background:#FEF2F2; color:#991B1B; }
        .kanban-col.converted .kanban-col-header { background:#ECFDF5; color:#065F46; }
        .kanban-col.subscriber .kanban-col-header { background:#F5F3FF; color:#5B21B6; }
        .kanban-col.lost .kanban-col-header { background:#F9FAFB; color:#6B7280; }
        .kanban-col-body { flex:1; overflow-y:auto; padding:8px; }

        /* Pipeline card */
        .p-card {
            padding:10px 12px; border-radius:8px; margin-bottom:6px; cursor:pointer;
            border:1px solid #E5E7EB; background:#fff; transition:all 0.15s;
        }
        .p-card:hover { border-color:#3B82F6; box-shadow:0 2px 8px rgba(59,130,246,0.15); }
        .p-card.active { border-color:#3B82F6; background:#EFF6FF; }
        .p-card-name { font-size:13px; font-weight:600; margin-bottom:2px; }
        .p-card-title { font-size:11px; color:#6B7280; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .p-card-footer { display:flex; justify-content:space-between; align-items:center; }
        .p-card-time { font-size:10px; color:#9CA3AF; }
        .p-card-score { font-size:10px; font-weight:700; padding:2px 6px; border-radius:6px; }
        .p-card-score.high { background:#FEE2E2; color:#991B1B; }
        .p-card-score.med { background:#FEF3C7; color:#92400E; }
        .p-card-score.low { background:#F3F4F6; color:#6B7280; }
        .p-card-reply { display:inline-block; font-size:9px; font-weight:700; padding:1px 5px; border-radius:4px; background:#DBEAFE; color:#1E40AF; margin-top:3px; }

        /* Right: Detail panel */
        .detail-panel {
            width:0; background:#fff; border-left:1px solid #E5E7EB; display:flex; flex-direction:column;
            transition:width 0.3s; overflow:hidden;
        }
        .detail-panel.open { width:480px; }
        .detail-header {
            padding:16px 20px; border-bottom:1px solid #E5E7EB; display:flex; align-items:center; gap:12px;
        }
        .detail-header .avatar { width:40px; height:40px; border-radius:50%; background:#3B82F6; color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:16px; flex-shrink:0; }
        .detail-header-info { flex:1; }
        .detail-header-info h2 { font-size:15px; font-weight:700; }
        .detail-header-info p { font-size:11px; color:#6B7280; }
        .detail-close { background:none; border:none; font-size:20px; cursor:pointer; color:#6B7280; padding:4px; }
        .detail-close:hover { color:#111; }

        /* Detail tabs */
        .detail-tabs { display:flex; border-bottom:1px solid #E5E7EB; }
        .detail-tab { flex:1; padding:10px; text-align:center; font-size:12px; font-weight:600; cursor:pointer; color:#6B7280; border-bottom:2px solid transparent; }
        .detail-tab.active { color:#3B82F6; border-bottom-color:#3B82F6; }

        .detail-body { flex:1; overflow-y:auto; }

        /* AI info section */
        .ai-info { padding:16px 20px; }
        .ai-row { display:flex; justify-content:space-between; padding:6px 0; font-size:12px; border-bottom:1px solid #F3F4F6; }
        .ai-row .label { color:#6B7280; }
        .ai-row .val { font-weight:600; }
        .ai-badge { display:inline-block; padding:2px 8px; border-radius:6px; font-size:11px; font-weight:700; }
        .ai-badge.hot { background:#FEE2E2; color:#991B1B; }
        .ai-badge.warm { background:#FEF3C7; color:#92400E; }
        .ai-badge.cold { background:#DBEAFE; color:#1E40AF; }

        /* Messages */
        .msg-list { padding:16px 20px; display:flex; flex-direction:column; gap:10px; }
        .msg-bubble { max-width:85%; padding:10px 14px; border-radius:14px; font-size:13px; line-height:1.5; }
        .msg-bubble.me { background:#3B82F6; color:#fff; margin-left:auto; border-bottom-right-radius:4px; }
        .msg-bubble.them { background:#F3F4F6; color:#1F2937; border-bottom-left-radius:4px; }
        .msg-sender { font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:2px; }
        .msg-bubble.me .msg-sender { color:rgba(255,255,255,0.6); text-align:right; }
        .msg-bubble.them .msg-sender { color:#9CA3AF; }
        .msg-time { font-size:9px; margin-top:4px; opacity:0.6; }
        .msg-bubble.me .msg-time { text-align:right; }

        /* LINKIFG reply area */
        .kimi-area { padding:12px 20px; border-top:2px solid #3B82F6; background:linear-gradient(135deg,#EFF6FF,#F5F3FF); }
        .kimi-area h4 { font-size:11px; font-weight:700; color:#3B82F6; margin-bottom:6px; }
        .kimi-area textarea { width:100%; border:1px solid #BFDBFE; border-radius:8px; padding:10px; font-size:13px; font-family:inherit; resize:vertical; min-height:80px; }
        .kimi-area .kimi-actions { display:flex; gap:6px; margin-top:8px; }

        /* Move buttons */
        .move-btns { padding:12px 20px; border-top:1px solid #E5E7EB; display:flex; gap:6px; flex-wrap:wrap; }
        .move-btn { padding:5px 10px; border-radius:6px; font-size:11px; font-weight:600; border:1px solid #E5E7EB; background:#fff; cursor:pointer; }
        .move-btn:hover { background:#F3F4F6; }
        .move-btn.hot { color:#DC2626; border-color:#FCA5A5; }
        .move-btn.converted { color:#059669; border-color:#6EE7B7; }
        .move-btn.lost { color:#6B7280; }

        /* Analysis Modal */
        .modal-overlay { display:none; position:fixed; top:0;left:0;right:0;bottom:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center; }
        .modal-overlay.active { display:flex; }
        .modal { background:#fff; border-radius:16px; width:90%; max-width:600px; max-height:80vh; overflow-y:auto; padding:24px; box-shadow:0 20px 60px rgba(0,0,0,0.3); }
        .modal h2 { font-size:18px; font-weight:700; margin-bottom:16px; }
        .modal-close { float:right; background:none; border:none; font-size:20px; cursor:pointer; color:#6B7280; }
        .report-step { display:flex; align-items:center; gap:12px; padding:12px; border-radius:8px; margin-bottom:8px; background:#F9FAFB; border:1px solid #E5E7EB; }
        .report-step.running { background:#FEF3C7; border-color:#FCD34D; }
        .report-step.done { background:#ECFDF5; border-color:#6EE7B7; }
        .report-step.error { background:#FEF2F2; border-color:#FCA5A5; }
        .report-step-icon { font-size:20px; }
        .report-step-info { flex:1; }
        .report-step-info h4 { font-size:13px; font-weight:600; }
        .report-step-info p { font-size:11px; color:#6B7280; margin-top:2px; }
        .report-step-badge { font-size:11px; font-weight:700; padding:2px 8px; border-radius:8px; }
        .report-summary { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:16px; }
        .report-stat { text-align:center; padding:12px; border-radius:8px; background:#F9FAFB; border:1px solid #E5E7EB; }
        .report-stat .val { font-size:20px; font-weight:700; }
        .report-stat .lbl { font-size:10px; color:#6B7280; margin-top:2px; }

        /* Chatbot */
        .chatbot-container { position:fixed; bottom:20px; right:20px; z-index:999; }
        .chatbot-toggle { width:56px; height:56px; border-radius:50%; background:linear-gradient(135deg,#3B82F6,#8B5CF6); border:none; color:#fff; font-size:24px; cursor:pointer; box-shadow:0 4px 20px rgba(59,130,246,0.4); transition:transform 0.2s; }
        .chatbot-toggle:hover { transform:scale(1.1); }
        .chatbot-panel { display:none; position:absolute; bottom:70px; right:0; width:380px; max-height:500px; background:#fff; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,0.2); overflow:hidden; flex-direction:column; }
        .chatbot-panel.open { display:flex; }
        .chatbot-header { padding:14px 16px; background:linear-gradient(135deg,#3B82F6,#8B5CF6); color:#fff; font-weight:700; font-size:14px; display:flex; align-items:center; gap:8px; }
        .chatbot-messages { flex:1; overflow-y:auto; padding:16px; max-height:340px; min-height:200px; }
        .chat-msg { margin-bottom:12px; max-width:85%; }
        .chat-msg.user { margin-left:auto; background:#3B82F6; color:#fff; padding:8px 12px; border-radius:12px 12px 2px 12px; font-size:13px; }
        .chat-msg.bot { background:#F3F4F6; color:#111827; padding:10px 14px; border-radius:12px 12px 12px 2px; font-size:13px; line-height:1.5; }
        .chat-typing { color:#9CA3AF; font-size:12px; font-style:italic; }
        .chatbot-input { display:flex; border-top:1px solid #E5E7EB; padding:8px; }
        .chatbot-input input { flex:1; border:1px solid #E5E7EB; border-radius:8px; padding:8px 12px; font-size:13px; outline:none; }
        .chatbot-input input:focus { border-color:#3B82F6; }
        .chatbot-input button { margin-left:6px; background:#3B82F6; color:#fff; border:none; border-radius:8px; padding:8px 14px; font-size:13px; font-weight:600; cursor:pointer; }
        .chatbot-input button:disabled { background:#9CA3AF; }

        .spinner { width:24px; height:24px; border:3px solid #E5E7EB; border-top-color:#3B82F6; border-radius:50%; animation:spin 0.6s linear infinite; }
        @keyframes spin { to { transform:rotate(360deg); } }

        .empty-col { text-align:center; padding:20px; color:#9CA3AF; font-size:12px; }

        /* Daily contact banner */
        .daily-banner { background:linear-gradient(135deg,#FEF3C7,#FDE68A); border-bottom:1px solid #F59E0B; padding:12px 24px; }
        .daily-banner h3 { font-size:14px; font-weight:700; color:#92400E; margin-bottom:8px; }
        .daily-list { display:flex; gap:8px; overflow-x:auto; padding-bottom:4px; }
        .daily-card { flex-shrink:0; background:#fff; border:1px solid #F59E0B; border-radius:10px; padding:10px 14px; min-width:200px; cursor:pointer; transition:all 0.15s; }
        .daily-card:hover { box-shadow:0 2px 12px rgba(245,158,11,0.3); transform:translateY(-1px); }
        .daily-card .dc-name { font-size:13px; font-weight:700; color:#1F2937; }
        .daily-card .dc-title { font-size:11px; color:#6B7280; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:180px; }
        .daily-card .dc-meta { display:flex; gap:8px; align-items:center; margin-top:6px; }
        .daily-card .dc-badge { font-size:10px; font-weight:700; padding:2px 6px; border-radius:4px; }
        .daily-card .dc-badge.urgent { background:#FEE2E2; color:#991B1B; }
        .daily-card .dc-badge.soon { background:#FEF3C7; color:#92400E; }
        .daily-card .dc-badge.reply { background:#DBEAFE; color:#1E40AF; }
        .daily-card .dc-reason { font-size:10px; color:#92400E; margin-top:4px; font-style:italic; }

        /* Schedule modal */
        .schedule-row { display:flex; gap:8px; align-items:center; margin-top:8px; }
        .schedule-row input[type="datetime-local"] { border:1px solid #BFDBFE; border-radius:6px; padding:6px 10px; font-size:12px; font-family:inherit; }
        .schedule-row .btn-schedule { background:#F59E0B; color:#fff; font-size:11px; padding:6px 12px; border-radius:6px; border:none; cursor:pointer; font-weight:600; }
        .schedule-row .btn-schedule:hover { background:#D97706; }
        .scheduled-badge { display:inline-block; background:#FEF3C7; color:#92400E; font-size:10px; font-weight:700; padding:3px 8px; border-radius:6px; margin-top:6px; }

        @media (max-width:768px) {
            .detail-panel.open { position:fixed; top:0; left:0; right:0; bottom:0; width:100%; z-index:100; }
            .kanban { flex-direction:column; }
            .kanban-col { min-width:100%; max-width:100%; }
        }
    </style>
</head>
<body>

    <!-- Analysis Modal -->
    <div class="modal-overlay" id="analysisModal">
        <div class="modal">
            <button class="modal-close" onclick="document.getElementById('analysisModal').classList.remove('active')">&times;</button>
            <h2>ü§ñ Analyse LINKIFG</h2>
            <div id="analysisSteps"></div>
            <div id="analysisReport"></div>
        </div>
    </div>

    <!-- Chatbot -->
    <div class="chatbot-container">
        <div class="chatbot-panel" id="chatbotPanel">
            <div class="chatbot-header">ü§ñ LINKIFG ‚Äî Assistant IA <span style="margin-left:auto;font-size:11px;opacity:0.8">connect√©</span></div>
            <div class="chatbot-messages" id="chatbotMessages"></div>
            <div style="padding:6px 12px;display:flex;gap:4px;flex-wrap:wrap;border-top:1px solid #E5E7EB">
                <button class="chat-quick-btn" data-q="Qui contacter en priorit√© aujourd'hui ?" style="font-size:10px;padding:3px 8px;border-radius:12px;border:1px solid #E5E7EB;background:#F9FAFB;cursor:pointer;color:#374151">üéØ Priorit√©s</button>
                <button class="chat-quick-btn" data-q="R√©sum√© pipeline" style="font-size:10px;padding:3px 8px;border-radius:12px;border:1px solid #E5E7EB;background:#F9FAFB;cursor:pointer;color:#374151">üìä Pipeline</button>
                <button class="chat-quick-btn" data-q="R√©dige un message pour mon meilleur hot lead" style="font-size:10px;padding:3px 8px;border-radius:12px;border:1px solid #E5E7EB;background:#F9FAFB;cursor:pointer;color:#374151">‚úçÔ∏è Message</button>
            </div>
            <div class="chatbot-input">
                <input type="text" id="chatbotInput" placeholder="Demande √† LINKIFG..." />
                <button id="chatbotSend">Envoyer</button>
            </div>
        </div>
        <button class="chatbot-toggle" id="chatbotToggle">ü§ñ</button>
    </div>

    <!-- Main layout -->
    <div class="pipeline-panel">
        <div class="pipeline-header">
            <h1>üîó LINKIFG</h1>
            <div class="stats" id="pipelineStats"></div>
            <div class="pipeline-actions">
                <button class="btn btn-primary" id="analyzeBtn">ü§ñ Analyser</button>
                <button class="btn btn-outline" id="syncConvertedBtn">‚úÖ Sync Convertis</button>
                <button class="btn btn-outline" id="syncBtn">üîÑ Sync</button>
            </div>
        </div>
        <div class="daily-banner" id="dailyBanner" style="display:none">
            <h3>üìã √Ä contacter aujourd'hui <span id="dailyCount" style="font-weight:400;font-size:12px"></span></h3>
            <div class="daily-list" id="dailyList"></div>
        </div>
        <div class="kanban" id="kanban">
            <div style="display:flex;align-items:center;justify-content:center;width:100%;padding:40px">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- Detail panel (slides in from right) -->
    <div class="detail-panel" id="detailPanel">
        <div class="detail-header" id="detailHeader"></div>
        <div class="detail-tabs">
            <div class="detail-tab active" data-tab="conv" onclick="switchTab('conv')">üí¨ Conversation</div>
            <div class="detail-tab" data-tab="ai" onclick="switchTab('ai')">ü§ñ AI Data</div>
        </div>
        <div class="detail-body" id="detailBody"></div>
        <div id="kimiArea"></div>
        <div class="move-btns" id="moveBtns"></div>
    </div>

    <script>
        const API_URL = 'https://linkedin-crm-dashboard-production.up.railway.app';
        const SUPABASE_URL = 'https://igyxcobujacampiqndpf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlneXhjb2J1amFjYW1waXFuZHBmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NDYxMTUsImV4cCI6MjA4NTUyMjExNX0.8jgz6G0Irj6sRclcBKzYE5VzzXNrxzHgrAz45tHfHpc';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allConvs = [];
        let activeConvId = null;
        let activeTab = 'conv';

        // ===== LOAD PIPELINE =====
        async function loadPipeline() {
            const { data: convs, error } = await db.from('conversations').select(`
                id, last_message_at, last_message_by, status, engagement_level,
                prospects (id, name, company, job_title, linkedin_url, sector),
                messages (content, sender, timestamp),
                ai_analysis (lead_score, lead_status, sentiment, interest_level, has_tested_ifg, reasoning, recommended_action, follow_up_timing, key_points, personalization_hints),
                follow_up_messages (generated_message, status, created_at)
            `).order('last_message_at', { ascending: false });

            if (error) { console.error(error); return; }
            allConvs = convs || [];

            const stages = {
                hot:        { label:'üî• Hot',        cls:'hot',        items:[] },
                warm:       { label:'üå°Ô∏è Warm',       cls:'warm',       items:[] },
                cold:       { label:'‚ùÑÔ∏è Cold',       cls:'cold',       items:[] },
                converted:  { label:'‚úÖ Converti',   cls:'converted',  items:[] },
                subscriber: { label:'üíé Abonn√©',     cls:'subscriber', items:[] },
                lost:       { label:'üí§ Perdu',      cls:'lost',       items:[] }
            };

            allConvs.forEach(c => {
                const a = Array.isArray(c.ai_analysis) ? c.ai_analysis[0] : c.ai_analysis;
                const p = c.prospects;
                if (!p) return;
                if (c.engagement_level === 'irrelevant') return;
                if (a?.recommended_action === 'ignore') return;

                let stage = 'cold';
                if (c.engagement_level === 'subscriber') stage = 'subscriber';
                else if (c.engagement_level === 'converted' || a?.has_tested_ifg) stage = 'converted';
                else if (c.status === 'archived' || c.engagement_level === 'lost') stage = 'lost';
                else if (a?.lead_status === 'hot' || c.engagement_level === 'hot') stage = 'hot';
                else if (a?.lead_status === 'warm' || c.engagement_level === 'warm') stage = 'warm';

                const msgs = (c.messages || []).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                const lastMsg = msgs[0];
                const now = Date.now();
                const lastTime = lastMsg ? new Date(lastMsg.timestamp).getTime() : new Date(c.last_message_at || 0).getTime();
                const days = Math.round((now - lastTime) / 86400000);
                const needsReply = c.last_message_by === 'them' || (lastMsg && lastMsg.sender !== 'me');

                stages[stage].items.push({
                    id: c.id, name: p.name, company: p.company, job_title: p.job_title,
                    linkedin_url: p.linkedin_url, score: a?.lead_score || 0,
                    days, needsReply, stage
                });
            });

            // Sort each stage by score desc
            Object.values(stages).forEach(s => s.items.sort((a,b) => b.score - a.score));

            // === DAILY CONTACT LIST ===
            const dailyContacts = [];
            allConvs.forEach(c => {
                const a = Array.isArray(c.ai_analysis) ? c.ai_analysis[0] : c.ai_analysis;
                const p = c.prospects;
                if (!p || !a) return;
                if (a.recommended_action === 'ignore' || c.engagement_level === 'irrelevant') return;
                if (c.engagement_level === 'lost' || c.status === 'archived') return;

                const msgs = (c.messages || []).sort((x,y) => new Date(y.timestamp) - new Date(x.timestamp));
                const lastMsg = msgs[0];
                const lastTime = lastMsg ? new Date(lastMsg.timestamp).getTime() : 0;
                const days = Math.round((Date.now() - lastTime) / 86400000);
                const lastBy = lastMsg?.sender || c.last_message_by;
                const needsReply = lastBy === 'them';

                let reason = '';
                let priority = 0;

                // They replied ‚Üí we MUST respond
                if (needsReply) {
                    reason = '‚ö° Ils ont r√©pondu ‚Äî √† vous !';
                    priority = 100 + (a.lead_score || 0);
                }
                // Follow-up timing matches
                else if (a.recommended_action === 'follow_up') {
                    const timingDays = { immediate:0, '2_days':2, '3_days':3, '5_days':5, '7_days':7, '10_days':10, '14_days':14 };
                    const targetDays = timingDays[a.follow_up_timing] ?? 7;
                    if (days >= targetDays) {
                        reason = `üîî Relance pr√©vue (${days}j depuis dernier msg)`;
                        priority = 50 + (a.lead_score || 0);
                    }
                }

                if (reason) {
                    dailyContacts.push({
                        id: c.id, name: p.name, job_title: p.job_title, company: p.company,
                        score: a.lead_score || 0, status: a.lead_status || 'cold',
                        days, needsReply, reason, priority
                    });
                }
            });

            dailyContacts.sort((a,b) => b.priority - a.priority);
            const banner = document.getElementById('dailyBanner');
            const dailyList = document.getElementById('dailyList');

            if (dailyContacts.length > 0) {
                banner.style.display = 'block';
                document.getElementById('dailyCount').textContent = `‚Äî ${dailyContacts.length} personne(s)`;
                dailyList.innerHTML = dailyContacts.slice(0, 15).map(dc => `
                    <div class="daily-card" onclick="openDetail('${dc.id}')">
                        <div class="dc-name">${dc.name}</div>
                        <div class="dc-title">${dc.job_title || ''}${dc.company ? ' @ '+dc.company : ''}</div>
                        <div class="dc-meta">
                            <span class="dc-badge ${dc.needsReply ? 'reply' : dc.score >= 70 ? 'urgent' : 'soon'}">${dc.score}/100</span>
                            <span style="font-size:10px;color:#92400E">${dc.days}j</span>
                        </div>
                        <div class="dc-reason">${dc.reason}</div>
                    </div>
                `).join('');
            } else {
                banner.style.display = 'none';
            }

            // Stats
            const total = Object.values(stages).reduce((s,st) => s + st.items.length, 0);
            document.getElementById('pipelineStats').innerHTML = 
                `<span class="stat-pill" style="background:#FEE2E2;color:#991B1B">üî• ${stages.hot.items.length}</span>` +
                `<span class="stat-pill" style="background:#FEF3C7;color:#92400E">üå°Ô∏è ${stages.warm.items.length}</span>` +
                `<span class="stat-pill" style="background:#DBEAFE;color:#1E40AF">‚ùÑÔ∏è ${stages.cold.items.length}</span>` +
                `<span class="stat-pill" style="background:#ECFDF5;color:#065F46">‚úÖ ${stages.converted.items.length}</span>` +
                `<span class="stat-pill" style="background:#F5F3FF;color:#5B21B6">üíé ${stages.subscriber.items.length}</span>` +
                `<span class="stat-pill" style="background:#FEF3C7;color:#92400E">üìã ${dailyContacts.length} √† contacter</span>` +
                `<span class="stat-pill" style="background:#F3F4F6;color:#6B7280">${total} total</span>`;

            // Render kanban
            let html = '';
            Object.entries(stages).forEach(([key, stage]) => {
                html += `<div class="kanban-col ${stage.cls}">
                    <div class="kanban-col-header">${stage.label} <span class="count">${stage.items.length}</span></div>
                    <div class="kanban-col-body">`;
                if (!stage.items.length) {
                    html += '<div class="empty-col">Aucun</div>';
                }
                stage.items.forEach(item => {
                    const sc = item.score >= 70 ? 'high' : item.score >= 40 ? 'med' : 'low';
                    const timeColor = item.days > 7 ? '#DC2626' : item.days > 3 ? '#F59E0B' : '#9CA3AF';
                    html += `<div class="p-card${item.id === activeConvId ? ' active' : ''}" onclick="openDetail('${item.id}')">
                        <div class="p-card-name">${item.name}</div>
                        <div class="p-card-title">${item.job_title || ''}${item.company ? ' @ '+item.company : ''}</div>
                        <div class="p-card-footer">
                            <span class="p-card-time" style="color:${timeColor}">${item.days === 0 ? "Auj" : item.days+'j'}</span>
                            <span class="p-card-score ${sc}">${item.score}/100</span>
                        </div>
                        ${item.needsReply ? '<span class="p-card-reply">‚ö° √Ä r√©pondre</span>' : ''}
                    </div>`;
                });
                html += '</div></div>';
            });
            document.getElementById('kanban').innerHTML = html;
        }

        // ===== OPEN DETAIL =====
        async function openDetail(convId) {
            activeConvId = convId;
            const panel = document.getElementById('detailPanel');
            panel.classList.add('open');

            // Highlight active card
            document.querySelectorAll('.p-card').forEach(c => c.classList.remove('active'));
            document.querySelector(`.p-card[onclick="openDetail('${convId}')"]`)?.classList.add('active');

            // Fetch full data
            const { data } = await db.from('conversations').select(`
                id, last_message_at, last_message_by, status, engagement_level,
                prospects (id, name, company, job_title, linkedin_url, sector, location),
                messages (content, sender, timestamp),
                ai_analysis (lead_score, lead_status, sentiment, interest_level, has_tested_ifg, reasoning, recommended_action, follow_up_timing, key_points, personalization_hints),
                follow_up_messages (generated_message, status, created_at)
            `).eq('id', convId).single();

            if (!data) return;

            const p = data.prospects || {};
            const a = Array.isArray(data.ai_analysis) ? data.ai_analysis[0] : data.ai_analysis;
            const msgs = (data.messages || []).sort((x,y) => new Date(x.timestamp) - new Date(y.timestamp));
            const followUp = Array.isArray(data.follow_up_messages) 
                ? data.follow_up_messages.sort((x,y) => new Date(y.created_at) - new Date(x.created_at))[0]
                : data.follow_up_messages;

            // Header
            document.getElementById('detailHeader').innerHTML = `
                <div class="avatar">${(p.name||'?').charAt(0)}</div>
                <div class="detail-header-info">
                    <h2>${p.name || 'Inconnu'}</h2>
                    <p>${p.job_title || ''}${p.company ? ' @ '+p.company : ''}${p.sector ? ' ¬∑ '+p.sector : ''}</p>
                    <a href="${p.linkedin_url || '#'}" target="_blank" style="font-size:11px;color:#3B82F6">Ouvrir LinkedIn ‚Üó</a>
                </div>
                <button class="detail-close" onclick="closeDetail()">&times;</button>`;

            // Store for later
            window._detail = { convId, name: p.name, msgs, analysis: a, followUp, prospect: p, engagement: data.engagement_level };

            switchTab(activeTab);

            // Move buttons
            const stage = data.engagement_level || a?.lead_status || 'cold';
            let movesHtml = '';
            const allStages = ['cold','warm','hot','converted','subscriber','lost'];
            allStages.forEach(s => {
                if (s === stage) return;
                const labels = { cold:'‚ùÑÔ∏è Cold', warm:'üå°Ô∏è Warm', hot:'üî• Hot', converted:'‚úÖ Converti', subscriber:'üíé Abonn√©', lost:'üí§ Perdu' };
                const cls = s === 'hot' ? 'hot' : s === 'converted' || s === 'subscriber' ? 'converted' : s === 'lost' ? 'lost' : '';
                movesHtml += `<button class="move-btn ${cls}" onclick="moveTo('${convId}','${s}')">${labels[s]}</button>`;
            });
            document.getElementById('moveBtns').innerHTML = movesHtml;

            // Reply area
            const replyMsg = followUp?.generated_message || '';
            // Default schedule: tomorrow 9am
            const tomorrow9 = new Date(); tomorrow9.setDate(tomorrow9.getDate()+1); tomorrow9.setHours(9,0,0,0);
            const schedDefault = tomorrow9.toISOString().slice(0,16);

            document.getElementById('kimiArea').innerHTML = `
                <div class="kimi-area">
                    <h4>ü§ñ R√©ponse LINKIFG</h4>
                    <textarea id="replyTextarea">${replyMsg}</textarea>
                    <div class="kimi-actions">
                        <button class="btn btn-primary" onclick="generateReply()" style="font-size:12px;padding:6px 12px">ü§ñ G√©n√©rer</button>
                        <button class="btn btn-outline" onclick="generateReply()" style="font-size:12px;padding:6px 12px">üîÑ Reg√©n√©rer</button>
                        <button class="btn btn-outline" onclick="copyReply()" style="font-size:12px;padding:6px 12px">üìã Copier</button>
                        <a class="btn btn-outline" href="${p.linkedin_url || '#'}" target="_blank" style="font-size:12px;padding:6px 12px;text-decoration:none;display:inline-block">üîó LinkedIn</a>
                    </div>
                    <div class="schedule-row">
                        <input type="datetime-local" id="scheduleTime" value="${schedDefault}" />
                        <button class="btn-schedule" onclick="scheduleMessage()">üìÖ Programmer l'envoi</button>
                    </div>
                    <div id="scheduleStatus"></div>
                </div>`;
        }

        function switchTab(tab) {
            activeTab = tab;
            document.querySelectorAll('.detail-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
            const d = window._detail;
            if (!d) return;

            const body = document.getElementById('detailBody');

            if (tab === 'conv') {
                // Messages
                if (!d.msgs.length) {
                    body.innerHTML = '<div class="empty-col">Aucun message</div>';
                    return;
                }
                body.innerHTML = '<div class="msg-list">' + d.msgs.map(m => `
                    <div class="msg-bubble ${m.sender === 'me' ? 'me' : 'them'}">
                        <div class="msg-sender">${m.sender === 'me' ? 'üì§ Moi (Aitor)' : 'üì© ' + d.name}</div>
                        ${m.content}
                    </div>
                `).join('') + '</div>';
                // Scroll to bottom
                body.scrollTop = body.scrollHeight;
            } else {
                // AI data
                const a = d.analysis || {};
                body.innerHTML = `<div class="ai-info">
                    <div class="ai-row"><span class="label">Score</span><span class="val">${a.lead_score || 0}/100</span></div>
                    <div class="ai-row"><span class="label">Status</span><span class="ai-badge ${a.lead_status || 'cold'}">${(a.lead_status || 'cold').toUpperCase()}</span></div>
                    <div class="ai-row"><span class="label">Sentiment</span><span class="val">${a.sentiment || '-'}</span></div>
                    <div class="ai-row"><span class="label">Int√©r√™t</span><span class="val">${a.interest_level || '-'}</span></div>
                    <div class="ai-row"><span class="label">A test√© IFG</span><span class="val">${a.has_tested_ifg ? '‚úÖ Oui' : '‚ùå Non'}</span></div>
                    <div class="ai-row"><span class="label">Action</span><span class="val">${a.recommended_action || '-'}</span></div>
                    <div class="ai-row"><span class="label">Timing relance</span><span class="val">${a.follow_up_timing || '-'}</span></div>
                    ${a.key_points?.length ? `<div style="margin-top:12px"><strong style="font-size:12px">Points cl√©s:</strong><div style="margin-top:6px">${a.key_points.map(p => `<span style="display:inline-block;background:#F3F4F6;padding:2px 8px;border-radius:4px;font-size:11px;margin:2px">${p}</span>`).join('')}</div></div>` : ''}
                    ${a.reasoning ? `<div style="margin-top:12px;padding:10px;background:#F9FAFB;border-radius:8px;font-size:12px;color:#374151;line-height:1.5"><strong>Raisonnement:</strong><br>${a.reasoning}</div>` : ''}
                    ${a.personalization_hints ? `<div style="margin-top:8px;font-size:12px;color:#6B7280"><strong>Personnalisation:</strong> ${a.personalization_hints}</div>` : ''}
                    <div style="margin-top:16px">
                        <strong style="font-size:12px">Prospect:</strong>
                        <div class="ai-row"><span class="label">Entreprise</span><span class="val">${d.prospect.company || '-'}</span></div>
                        <div class="ai-row"><span class="label">Poste</span><span class="val">${d.prospect.job_title || '-'}</span></div>
                        <div class="ai-row"><span class="label">Secteur</span><span class="val">${d.prospect.sector || '-'}</span></div>
                        <div class="ai-row"><span class="label">Localisation</span><span class="val">${d.prospect.location || '-'}</span></div>
                    </div>
                </div>`;
            }
        }

        function closeDetail() {
            document.getElementById('detailPanel').classList.remove('open');
            activeConvId = null;
            document.querySelectorAll('.p-card').forEach(c => c.classList.remove('active'));
        }

        async function moveTo(convId, newStage) {
            const map = {
                cold: { engagement_level:'cold', status:'active' },
                warm: { engagement_level:'warm', status:'active' },
                hot: { engagement_level:'hot', status:'active' },
                converted: { engagement_level:'converted', status:'converted' },
                subscriber: { engagement_level:'subscriber', status:'converted' },
                lost: { engagement_level:'lost', status:'archived' }
            };
            await db.from('conversations').update(map[newStage]).eq('id', convId);
            closeDetail();
            loadPipeline();
        }

        async function generateReply() {
            const d = window._detail;
            if (!d) return;
            const textarea = document.getElementById('replyTextarea');
            textarea.value = '‚è≥ G√©n√©ration en cours...';

            try {
                const conversation = d.msgs.map(m => `${m.sender === 'me' ? 'Moi' : d.name}: ${m.content}`).join('\n');
                const res = await fetch(`${API_URL}/api/generate-message`, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ prospect_name: d.name, conversation })
                });
                const data = await res.json();
                textarea.value = data.success ? data.message : '‚ùå ' + (data.error || 'Erreur');
            } catch(e) { textarea.value = '‚ùå ' + e.message; }
        }

        async function copyReply() {
            const textarea = document.getElementById('replyTextarea');
            if (!textarea?.value) return;
            await navigator.clipboard.writeText(textarea.value);
            const btn = event.target;
            btn.textContent = '‚úÖ Copi√© !';
            setTimeout(() => btn.textContent = 'üìã Copier', 1500);
        }

        async function scheduleMessage() {
            const d = window._detail;
            if (!d) return;
            const textarea = document.getElementById('replyTextarea');
            const msg = textarea?.value?.trim();
            if (!msg || msg.startsWith('‚è≥') || msg.startsWith('‚ùå')) {
                alert('G√©n√®re d\'abord un message avant de programmer.');
                return;
            }
            const schedTime = document.getElementById('scheduleTime').value;
            if (!schedTime) { alert('Choisis une date/heure.'); return; }

            const statusEl = document.getElementById('scheduleStatus');
            statusEl.innerHTML = '<span style="font-size:11px;color:#92400E">‚è≥ Programmation...</span>';

            try {
                const { error } = await db.from('scheduled_messages').insert({
                    conversation_id: d.convId,
                    message: msg,
                    scheduled_at: new Date(schedTime).toISOString(),
                    status: 'scheduled'
                });
                if (error) throw error;
                const dt = new Date(schedTime);
                statusEl.innerHTML = `<span class="scheduled-badge">üìÖ Programm√© pour ${dt.toLocaleDateString('fr-FR')} √† ${dt.toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit'})}</span>`;
            } catch(e) {
                statusEl.innerHTML = `<span style="font-size:11px;color:#DC2626">‚ùå ${e.message}</span>`;
            }
        }

        // ===== SYNC =====
        document.getElementById('syncBtn').addEventListener('click', async function() {
            this.disabled = true; this.textContent = '‚è≥ Sync...';
            try {
                await fetch(`${API_URL}/scrape`, { method:'POST' });
                loadPipeline();
            } catch(e) { alert('Erreur: ' + e.message); }
            finally { this.disabled = false; this.textContent = 'üîÑ Sync'; }
        });

        // ===== ONE-CLICK ANALYSIS =====
        document.getElementById('analyzeBtn').addEventListener('click', async function() {
            const btn = this;
            const modal = document.getElementById('analysisModal');
            const stepsEl = document.getElementById('analysisSteps');
            const reportEl = document.getElementById('analysisReport');
            btn.disabled = true; btn.textContent = '‚è≥ Analyse...';
            modal.classList.add('active'); reportEl.innerHTML = '';

            stepsEl.innerHTML = `
                <div class="report-step running" id="step-scrape"><div class="report-step-icon">üì¨</div><div class="report-step-info"><h4>Scraping</h4><p>Nouveaux messages...</p></div><div class="report-step-badge" style="background:#FEF3C7;color:#92400E">En cours</div></div>
                <div class="report-step" id="step-ai"><div class="report-step-icon">ü§ñ</div><div class="report-step-info"><h4>Analyse IA</h4><p>Attente...</p></div><div class="report-step-badge" style="background:#F3F4F6;color:#6B7280">Attente</div></div>
                <div class="report-step" id="step-list"><div class="report-step-icon">üìã</div><div class="report-step-info"><h4>Contact list</h4><p>Attente...</p></div><div class="report-step-badge" style="background:#F3F4F6;color:#6B7280">Attente</div></div>`;

            try {
                const res = await fetch(`${API_URL}/api/full-analysis`, { method:'POST' });
                const data = await res.json();
                if (!data.success) throw new Error(data.error);

                data.steps.forEach(s => {
                    const el = document.getElementById(`step-${s.step === 'ai_analysis' ? 'ai' : s.step === 'contact_list' ? 'list' : s.step}`);
                    if (el) {
                        el.className = `report-step ${s.status === 'done' ? 'done' : 'error'}`;
                        el.querySelector('.report-step-badge').textContent = s.status === 'done' ? `‚úÖ ${(s.duration/1000).toFixed(1)}s` : '‚ùå';
                        el.querySelector('.report-step-badge').style.cssText = s.status === 'done' ? 'background:#ECFDF5;color:#065F46' : 'background:#FEF2F2;color:#991B1B';
                    }
                });

                const r = data.report;
                reportEl.innerHTML = `<h3 style="font-size:15px;font-weight:700;margin:16px 0 12px">üìä Rapport</h3>
                    <div class="report-summary">
                        <div class="report-stat"><div class="val">${r.conversations_analyzed}</div><div class="lbl">Analys√©es</div></div>
                        <div class="report-stat" style="background:#FEE2E2"><div class="val" style="color:#991B1B">üî• ${r.hot_leads}</div><div class="lbl">Hot</div></div>
                        <div class="report-stat" style="background:#FEF3C7"><div class="val" style="color:#92400E">${r.warm_leads}</div><div class="lbl">Warm</div></div>
                        <div class="report-stat" style="background:#ECFDF5"><div class="val" style="color:#065F46">üéØ ${r.contact_today}</div><div class="lbl">√Ä contacter</div></div>
                        <div class="report-stat"><div class="val">${r.new_messages_saved}</div><div class="lbl">Nouveaux msg</div></div>
                        <div class="report-stat"><div class="val">${r.errors}</div><div class="lbl">Erreurs</div></div>
                    </div>`;
                loadPipeline();
            } catch(e) {
                stepsEl.innerHTML += `<div class="report-step error"><div class="report-step-icon">‚ùå</div><div class="report-step-info"><h4>Erreur</h4><p>${e.message}</p></div></div>`;
            } finally { btn.disabled = false; btn.textContent = 'ü§ñ Analyser'; }
        });

        // ===== CHATBOT =====
        const chatHistory = [];
        document.getElementById('chatbotToggle').addEventListener('click', () => {
            const p = document.getElementById('chatbotPanel');
            p.classList.toggle('open');
            if (p.classList.contains('open') && document.getElementById('chatbotMessages').children.length === 0)
                addBotMsg('Salut ! üëã Pose-moi une question sur ton pipeline.');
            if (p.classList.contains('open')) document.getElementById('chatbotInput').focus();
        });
        document.getElementById('chatbotSend').addEventListener('click', sendChat);
        document.getElementById('chatbotInput').addEventListener('keydown', e => { if (e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChat();} });
        document.querySelectorAll('.chat-quick-btn').forEach(b => b.addEventListener('click', () => { document.getElementById('chatbotInput').value=b.dataset.q; sendChat(); }));

        function addBotMsg(t) { const d=document.createElement('div'); d.className='chat-msg bot'; d.innerHTML=t.replace(/\n/g,'<br>').replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>'); document.getElementById('chatbotMessages').appendChild(d); document.getElementById('chatbotMessages').scrollTop=9999; }
        function addUserMsg(t) { const d=document.createElement('div'); d.className='chat-msg user'; d.textContent=t; document.getElementById('chatbotMessages').appendChild(d); document.getElementById('chatbotMessages').scrollTop=9999; }

        async function sendChat() {
            const q = document.getElementById('chatbotInput').value.trim();
            if (!q) return;
            document.getElementById('chatbotInput').value = '';
            addUserMsg(q); chatHistory.push({role:'user',content:q});
            document.getElementById('chatbotSend').disabled = true;
            const typing = document.createElement('div'); typing.className='chat-msg bot chat-typing'; typing.textContent='LINKIFG r√©fl√©chit...';
            document.getElementById('chatbotMessages').appendChild(typing);
            try {
                const res = await fetch(`${API_URL}/api/linkifg-chat`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({question:q,history:chatHistory.slice(-6)}) });
                const data = await res.json(); typing.remove();
                if (data.success) { addBotMsg(data.answer); chatHistory.push({role:'assistant',content:data.answer}); }
                else addBotMsg('‚ùå ' + (data.error||'Erreur'));
            } catch(e) { typing.remove(); addBotMsg('‚ùå '+e.message); }
            finally { document.getElementById('chatbotSend').disabled = false; document.getElementById('chatbotInput').focus(); }
        }

        // Sync Converted button
        document.getElementById('syncConvertedBtn').addEventListener('click', async function() {
            this.disabled = true; this.textContent = '‚è≥ Sync...';
            try {
                const res = await fetch(`${API_URL}/api/sync-converted`, { method:'POST' });
                const data = await res.json();
                if (data.success) {
                    this.textContent = `‚úÖ ${data.matched} trouv√©(s)`;
                    setTimeout(() => { this.textContent = '‚úÖ Sync Convertis'; this.disabled = false; }, 2000);
                    loadPipeline();
                } else throw new Error(data.error);
            } catch(e) { alert('Erreur: ' + e.message); this.disabled = false; this.textContent = '‚úÖ Sync Convertis'; }
        });

        // Init ‚Äî auto sync converted on load
        async function init() {
            loadPipeline();
            // Auto sync converted in background
            try {
                const res = await fetch(`${API_URL}/api/sync-converted`, { method:'POST' });
                const data = await res.json();
                if (data.matched > 0) loadPipeline();
            } catch(e) {}
        }
        init();
        db.channel('changes').on('postgres_changes', { event:'*', schema:'public', table:'conversations' }, loadPipeline).subscribe();
    </script>
</body>
</html>
